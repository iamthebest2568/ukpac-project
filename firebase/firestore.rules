rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() && request.auth.token.admin == true;
    }

    // PDPA acceptance helper: accepts either top-level field or payload.{PDPA|pdpa} as boolean or string 'accepted'
    function pdpaAcceptedFor(resource) {
      return (
        (resource.PDPA == true) ||
        (resource.pdpa == true) ||
        (resource.PDPA == "accepted") ||
        (resource.pdpa == "accepted") ||
        (resource.payload != null && (
          resource.payload.PDPA == true ||
          resource.payload.pdpa == true ||
          resource.payload.PDPA == "accepted" ||
          resource.payload.pdpa == "accepted"
        ))
      );
    }

    // Generic entry validation used by event collections
    function isValidEventEntry(resource) {
      return resource.keys().hasAll(['sessionID','timestamp','event','payload'])
        && resource.sessionID is string
        && resource.sessionID.size() <= 128
        && (resource.timestamp is int || resource.timestamp is string)
        && resource.event is string
        && resource.event.size() <= 64
        && resource.payload is map
        && (!('PDPA' in resource) || resource.PDPA is bool || resource.PDPA is string)
        && (!('ip' in resource) || (resource.ip is string && resource.ip.size() <= 64))
        && (!('userAgent' in resource) || (resource.userAgent is string && resource.userAgent.size() <= 1024));
    }

    // Rules for minigame1_events collection (accept client writes; restrict reads/updates)
    match /minigame1_events/{eventId} {
      // Allow create from clients but validate structure to avoid abuse
      allow create: if isValidEventEntry(request.resource.data);

      // Restrict read/update/delete to admins only
      allow get, list, update, delete: if isAdmin();
    }

    // (Legacy) ukpack2_events preserved but locked down to admin-only
    match /ukpack2_events/{eventId} {
      allow create: if false;
      allow get, list, update, delete: if isAdmin();
    }

    // Deny all other reads/writes by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
